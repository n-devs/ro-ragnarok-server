"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t,e=require("pako"),r=(t=require("jdataview"))&&"object"==typeof t&&"default"in t?t.default:t,n=require("fs"),i=function(t,e){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};function o(t,e){function r(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}function s(t,e,r,n){return new(r||(r=Promise))((function(i,o){function s(t){try{u(n.next(t))}catch(t){o(t)}}function a(t){try{u(n.throw(t))}catch(t){o(t)}}function u(t){var e;t.done?i(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,a)}u((n=n.apply(t,e||[])).next())}))}function a(t,e){var r,n,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],n=0}finally{r=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}var u=new Uint8Array([128,64,32,16,8,4,2,1]),f=new Uint8Array(8),c=new Uint8Array(8),l=new Uint8Array(8),h=new Uint8Array([58,50,42,34,26,18,10,2,60,52,44,36,28,20,12,4,62,54,46,38,30,22,14,6,64,56,48,40,32,24,16,8,57,49,41,33,25,17,9,1,59,51,43,35,27,19,11,3,61,53,45,37,29,21,13,5,63,55,47,39,31,23,15,7]),d=new Uint8Array([40,8,48,16,56,24,64,32,39,7,47,15,55,23,63,31,38,6,46,14,54,22,62,30,37,5,45,13,53,21,61,29,36,4,44,12,52,20,60,28,35,3,43,11,51,19,59,27,34,2,42,10,50,18,58,26,33,1,41,9,49,17,57,25]),p=new Uint8Array([16,7,20,21,29,12,28,17,1,15,23,26,5,18,31,10,2,8,24,14,32,27,3,9,19,13,30,6,22,11,4,25]),v=[new Uint8Array([239,3,65,253,216,116,30,71,38,239,251,34,179,216,132,30,57,172,167,96,98,193,205,186,92,150,144,89,5,59,122,133,64,253,30,200,231,138,139,33,218,67,100,159,45,20,177,114,245,91,200,182,156,55,118,236,57,160,163,5,82,110,15,217]),new Uint8Array([167,221,13,120,158,11,227,149,96,54,54,79,249,96,90,163,17,36,210,135,200,82,117,236,187,193,76,186,36,254,143,25,218,19,102,175,73,208,144,6,140,106,251,145,55,141,13,120,191,73,17,244,35,229,206,59,85,188,162,87,232,34,116,206]),new Uint8Array([44,234,193,191,74,36,31,194,121,71,162,124,182,217,104,21,128,86,93,1,51,253,244,174,222,48,7,155,229,131,155,104,73,180,46,131,31,194,181,124,162,25,216,229,124,47,131,218,247,107,144,254,196,1,90,151,97,166,61,64,11,88,230,61]),new Uint8Array([77,209,178,15,40,189,228,120,246,74,15,147,139,23,209,164,58,236,201,53,147,86,126,203,85,32,160,254,108,137,23,98,23,98,75,177,180,222,209,135,201,20,60,74,126,168,226,125,160,159,246,92,106,9,141,240,15,227,83,37,149,54,40,203])];function y(t,e){for(var r=0;r<8;r++)c[r]=t[e+r];!function(t,e){f[0]=63&(t[e+7]<<5|t[e+4]>>3),f[1]=63&(t[e+4]<<1|t[e+5]>>7),f[2]=63&(t[e+4]<<5|t[e+5]>>3),f[3]=63&(t[e+5]<<1|t[e+6]>>7),f[4]=63&(t[e+5]<<5|t[e+6]>>3),f[5]=63&(t[e+6]<<1|t[e+7]>>7),f[6]=63&(t[e+6]<<5|t[e+7]>>3),f[7]=63&(t[e+7]<<1|t[e+4]>>7),t.set(f,e),f.set(l)}(c,0),function(t,e){for(var r=0;r<4;++r)f[r]=240&v[r][t[2*r+0+e]]|15&v[r][t[2*r+1+e]];t.set(f,e),f.set(l)}(c,0),function(t,e){for(var r=0;r<32;++r){var n=p[r]-1;t[e+(n>>3)]&u[7&n]&&(f[4+(r>>3)]|=u[7&r])}t.set(f,e),f.set(l)}(c,0),t[e+0]^=c[4],t[e+1]^=c[5],t[e+2]^=c[6],t[e+3]^=c[7]}function w(t,e){!function(t,e){for(var r=0;r<64;++r){var n=h[r]-1;t[e+(n>>3&7)]&u[7&n]&&(f[r>>3&7]|=u[7&r])}t.set(f,e),f.set(l)}(t,e),y(t,e),function(t,e){for(var r=0;r<64;++r){var n=d[r]-1;t[e+(n>>3&7)]&u[7&n]&&(f[r>>3&7]|=u[7&r])}t.set(f,e),f.set(l)}(t,e)}function g(t,e){f[0]=t[e+3],f[1]=t[e+4],f[2]=t[e+6],f[3]=t[e+0],f[4]=t[e+1],f[5]=t[e+2],f[6]=t[e+5],f[7]=b[t[e+7]],t.set(f,e),f.set(l)}var b=function(){for(var t=new Uint8Array([0,43,108,128,1,104,72,119,96,255,185,192,254,235]),e=new Uint8Array(Array.from({length:256},(function(t,e){return e}))),r=t.length,n=0;n<r;n+=2)e[t[n+0]]=t[n+1],e[t[n+1]]=t[n+0];return e}(),A=2*Uint32Array.BYTES_PER_ELEMENT,m=function(){function t(t){this.fd=t,this.version=512,this.fileCount=0,this.loaded=!1,this.files=new Map,this.fileTableOffset=0}return t.prototype.getStreamReader=function(t,e){return s(this,void 0,void 0,(function(){var n;return a(this,(function(i){switch(i.label){case 0:return[4,this.getStreamBuffer(this.fd,t,e)];case 1:return n=i.sent(),[2,new r(n,void 0,void 0,!0)]}}))}))},t.prototype.load=function(){return s(this,void 0,void 0,(function(){return a(this,(function(t){switch(t.label){case 0:return this.loaded?[3,3]:[4,this.parseHeader()];case 1:return t.sent(),[4,this.parseFileList()];case 2:t.sent(),this.loaded=!0,t.label=3;case 3:return[2]}}))}))},t.prototype.parseHeader=function(){return s(this,void 0,void 0,(function(){var t,e;return a(this,(function(r){switch(r.label){case 0:return[4,this.getStreamReader(0,46)];case 1:if(t=r.sent(),"Master of Magic"!==t.getString(15))throw Error("Not a GRF file (invalid signature)");if(t.skip(15),this.fileTableOffset=t.getUint32()+46,e=t.getUint32(),this.fileCount=t.getUint32()-e-7,this.version=t.getUint32(),512!==this.version)throw Error('Unsupported version "0x'+this.version.toString(16)+'"');return[2]}}))}))},t.prototype.parseFileList=function(){return s(this,void 0,void 0,(function(){var t,r,n,i,o,s,u,f;return a(this,(function(a){switch(a.label){case 0:return[4,this.getStreamReader(this.fileTableOffset,A)];case 1:return t=a.sent(),r=t.getUint32(),t.getUint32(),[4,this.getStreamBuffer(this.fd,this.fileTableOffset+A,r)];case 2:for(n=a.sent(),i=e.inflate(n,{}),o=0,s=0;o<this.fileCount;++o){for(u="";i[s];)u+=String.fromCharCode(i[s++]);s++,1&(f={compressedSize:i[s++]|i[s++]<<8|i[s++]<<16|i[s++]<<24,lengthAligned:i[s++]|i[s++]<<8|i[s++]<<16|i[s++]<<24,realSize:i[s++]|i[s++]<<8|i[s++]<<16|i[s++]<<24,type:i[s++],offset:i[s++]|i[s++]<<8|i[s++]<<16|i[s++]<<24}).type&&this.files.set(u.toLowerCase(),f)}return[2]}}))}))},t.prototype.decodeEntry=function(t,r){return 2&r.type?function(t,e,r){for(var n=r.toString().length,i=n<3?1:n<5?n+1:n<7?n+9:n+15,o=e>>3,s=0;s<20&&s<o;++s)w(t,8*s);s=20;for(var a=-1;s<o;++s)s%i!=0?++a&&a%7==0&&g(t,8*s):w(t,8*s)}(t,r.lengthAligned,r.compressedSize):4&r.type&&function(t,e){for(var r=e>>3,n=0;n<20&&n<r;++n)w(t,8*n)}(t,r.lengthAligned),r.realSize===r.compressedSize?t:e.inflate(t,{})},t.prototype.getFile=function(t){return s(this,void 0,void 0,(function(){var e,r,n,i;return a(this,(function(o){switch(o.label){case 0:return this.loaded?(e=t.toLowerCase(),this.files.has(e)?(r=this.files.get(e),[4,this.getStreamBuffer(this.fd,r.offset+46,r.lengthAligned)]):[2,Promise.resolve({data:null,error:'File "'+e+'" not found'})]):[2,Promise.resolve({data:null,error:"GRF not loaded yet"})];case 1:n=o.sent();try{return i=this.decodeEntry(n,r),[2,Promise.resolve({data:i,error:null})]}catch(t){return[2,Promise.resolve({data:null,error:t})]}return[2]}}))}))},t}(),U=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return o(e,t),e.prototype.getStreamBuffer=function(t,e,r){return s(this,void 0,void 0,(function(){return a(this,(function(n){return[2,new Promise((function(n,i){var o=new FileReader;o.onerror=i,o.onload=function(){return n(new Uint8Array(o.result))},o.readAsArrayBuffer(t.slice(e,e+r))}))]}))}))},e}(m),S=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return o(e,t),e.prototype.getStreamBuffer=function(t,e,r){return s(this,void 0,void 0,(function(){var i;return a(this,(function(o){switch(o.label){case 0:return i=Buffer.alloc(r),[4,new Promise((function(o,s){return n.read(t,i,0,r,e,(function(t){return t?s(t):o()}))}))];case 1:return o.sent(),[2,i]}}))}))},e}(m);exports.GrfBrowser=U,exports.GrfNode=S;
//# sourceMappingURL=grf-loader.min.js.map
